#!/bin/bash
# Uses a playlist in m3u format and copies all files in that playlist
# into a directory. Additionally every flac file will be converted to
# ogg to safe some space.

playlist="${1}"
dest_dir="${2}"
new_playlist="${3}"

if [[ -z "${playlist}" || -z "${dest_dir}" || -z "${new_playlist}" ]]; then
   echo "$0 playlist dest_dir new_playlist"
   exit 1
fi

counter=0
IFS=$(echo -e "\n\b")
for file in $(cat "${playlist}" | grep -v ^#); do
    hash=$(md5sum "$file" | awk '{print $1}')
    ext=$(echo "$file" | sed -e 's/^.*\.\(.*\)$/\1/')
    newname="${dest_dir}/$(printf "%04d" $counter)-${hash}"

    echo "Copying \"${file}\" .."
    cp "$file" "${newname}.${ext}"

    if [[ "${ext}" = "flac" ]]; then
        oggenc "${newname}.${ext}"
        rm -vf "${newname}.${ext}"
        echo "${newname}.ogg" >> "${new_playlist}"
    else
        echo "${newname}.${ext}" >> "${new_playlist}"
    fi

    ((counter=$counter+1))
done
