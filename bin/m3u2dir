#!/bin/bash
# Uses a playlist in m3u format and copies all files in that playlist
# into a directory. Additionally every flac file will be converted to
# ogg to safe some space.

playlist="${1}"
dest="${2}"

if [[ -z "${playlist}" || -z "${dest}" ]]; then
   echo "$0 playlist destination"
   exit 1
fi

counter=0
IFS=$(echo -e "\n\b")
for file in $(cat "${playlist}" | grep -v ^#); do
    hash=$(md5sum "$file" | awk '{print $1}')
    ext=$(echo "$file" | sed -e 's/^.*\.\(.*\)$/\1/')
    newname="${dest}/$(printf "%04d" $counter)-${hash}"

    echo "Copying \"${file}\" .."
    cp "$file" "${newname}.${ext}"

    if [[ "${ext}" = "flac" ]]; then
        oggenc "${newname}.${ext}"
        rm -vf "${newname}.${ext}"
    fi

    ((counter=$counter+1))
done
